var Reimprimir=Class.create(HfosProcessContainer,{initialize:function(a){this.setContainer(a);this._setIndexCallbacks()},_setIndexCallbacks:function(){var a=this.getElement("printButton");a.observe("click",this._reimprimirFactura.bind(this,a))},_reimprimirFactura:function(){var a=this.getElement("reimprimirForm");new HfosAjax.JsonFormRequest(a,{onLoading:function(a){this.getElement("headerSpinner").show();a.disable()}.bind(this,a),onSuccess:function(a){"OK"==a.status?(this.getMessages().success(a.message),
window.open($Kumbia.path+"temp/"+a.uri)):"FAILED"==a.status&&this.getMessages().error(a.message)}.bind(this),onComplete:function(a){this.getElement("headerSpinner").hide();a.enable()}.bind(this,a)})}});HfosBindings.late("win-reimprimir","afterCreate",function(a){new Reimprimir(a)});var Facturas=Class.create(HfosProcessContainer,{_key:null,_movimientos:[],_activeMov:0,initialize:function(a){this.setContainer(a);this._setNewCallbacks()},_selectRow:function(a){var b=a.up(1);b.hasClassName("lineaError")||(a.checked?b.addClassName("selectedRow"):b.removeClassName("selectedRow"));for(var a=0,b=this.select('input[type="checkbox"]'),c=0;c<b.length;c++)b[c].checked&&a++;b=this.getStatusBarElement("movimientoSeleccion");0<a?b.show():b.hide()},_selectRowForma:function(a){var b=a.up(1);
b.hasClassName("lineaError")||(a.checked?b.addClassName("selectedRow"):b.removeClassName("selectedRow"));for(var a=0,b=this.select('input[type="checkbox"]'),c=0;c<b.length;c++)b[c].checked&&a++;b=this.getStatusBarElement("movimientoSeleccion");0<a?b.show():b.hide()},_saveFactura:function(){var a=this.getElement("grabarForm");new HfosAjax.JsonFormRequest(a,{onLoading:function(a){this.getElement("headerSpinner").show();a.disable()}.bind(this,a),onSuccess:function(a){"OK"==a.status?(this.getMessages().success(a.message),
window.open($Kumbia.path+"temp/"+a.uri),Hfos.getApplication().getWorkspace().getWindowManager().getActiveWindow().close()):"FAILED"==a.status&&this.getMessages().error(a.message)}.bind(this),onComplete:function(a){this.getElement("headerSpinner").hide();a.enable()}.bind(this,a)})},_setNewCallbacks:function(){var a=this.getElement("saveButton");a.observe("click",this._saveFactura.bind(this,a));a=this.selectOne("#descuentoGeneral");a.observe("blur",this._setDescuento.bind(this,a));a=this.getElement("queryPedido");
a.observe("click",this.queryPedido.bind(this,a));(a=this.selectOne("input#numeroPedido"))&&a.observe("blur",this.checkLoadPedido.bind(this,a));this.selectOne("input#nitFacturar").activate();new HfosTabs(this,"tabbed",{});this._addGridCallbacks(1);this._addGridFormCallbacks(1);this._showTotalBar()},_setDescuento:function(a){var b=this.select("input.precio");""!=a.getValue().strip()&&parseFloat(a.getValue(),10);for(a=0;a<b.length;a++){var c=b[a].up(1),d=c.getElement("item"),e=c.getElement("cantidad"),
f=c.getElement("itemIvaVenta"),c=c.getElement("itemPrecioVenta");this._onBlurItem(d);this._onBlurCantidad(e,f,c)}this._totalizeFactura()},_showTotalBar:function(){var a;this.showStatusBar('<table width="100%" class="movimientoStatusBar"><tr><td align="left" style="display:none" class="movimientoSeleccion">Opciones de la Selecci\u00f3n <select class="opcionesSeleccion"><option value="@">Seleccione...</option><option value="D">Eliminar</option></select></td><td class="totalFactura" align="right"></td></tr></table>');
a=this.getStatusBarElement("opcionesSeleccion");a.observe("change",function(a){try{switch($F(a)){case "D":this._deleteRows()}a.setValue("@")}catch(c){HfosException.show(c)}}.bind(this,a));this._totalFactura=this.getStatusBarElement("totalFactura");this._totalFactura.update("")},_deleteRows:function(){for(var a=0,b=this.select('.detalle-grid input[type="checkbox"]'),c=0;c<b.length;c++)b[c].checked&&a++;0<a&&(b.length==a?new HfosModal.alert({title:"Facturas",message:"La factura debe tener al menos un item"}):
new HfosModal.confirm({title:"Facturas",message:"Seguro desea eliminar los items seleccionados?",onAccept:function(){for(var a=[],b=this.select('input[type="checkbox"]'),c=0;c<b.length;c++)b[c].checked&&a.push(b[c].up(1).retrieve("position"));for(c=0;c<a.length;c++)this.getElement("linea"+a[c]).erase();this._totalizeFactura()}.bind(this)}))},_pushRowForUpdate:function(a,b){var c=parseInt(a.up(1).retrieve("position"),10)+1;if(null==this.getElement("linea"+c)&&0<c){var d=document.createElement("TR");
d.addClassName("linea"+c);d.addClassName("detalle-linea");var e=document.createElement("TD");e.addClassName("numero");e.update(c);d.appendChild(e);e=document.createElement("TD");e.update('<input type="checkbox" class="itemCheck" id="itemCheck'+c+'"/>');d.appendChild(e);var f=document.createElement("TD");f.addClassName("numero");f.update('<input type="text" class="item numeric" name="item[]" id="item'+c+'" size="7"/>');e=document.createElement("DIV");e.addClassName("numero");e.update('<input type="hidden" class="itemIvaVenta" name="itemIvaVenta[]" id="itemIvaVenta'+
c+'" size="7"/>');f.appendChild(e);var g=document.createElement("DIV");g.addClassName("numero");g.update('<input type="hidden" class="itemPrecioVenta" name="itemPrecioVenta[]" id="itemPrecioVenta'+c+'" size="7"/>');f.appendChild(g);d.appendChild(f);f=document.createElement("TD");f.addClassName("numero");f.update('<input type="text" class="descripcion" name="descripcion[]" id="descripcion'+c+'" size="20"/>');d.appendChild(f);f=document.createElement("TD");f.update('<input type="text" class="cantidad numeric" name="cantidad[]" id="cantidad'+
c+'" size="7"/>');d.appendChild(f);var h=document.createElement("TD"),i=this.select("select.tipo")[0];h.appendChild(i.cloneNode(!0));d.appendChild(h);h=document.createElement("TD");h.update('<input type="text" class="precio numeric" name="precio[]" id="precio'+c+'" size="9" readonly/>');d.appendChild(h);h=document.createElement("TD");h.update('<input type="text" class="total numeric" name="total[]" id="total'+c+'" size="9" readonly/>');d.appendChild(h);this.getElement("ordenes-body").appendChild(d);
this._addGridCallbacks(c);"undefined"==typeof b?(a.hasClassName("valor")&&window.setTimeout(function(){this.select("input.item")[c-1].activate()}.bind(this),100),this.scrollToBottom(),this._notifyContentChange()):"function"==typeof b&&b();this._onBlurCantidad(f,e,g)}},_updateCodigoItem:function(a,b){a&&a.setValue(b.value)},_addGridCallbacks:function(a){var b=this.getElement("linea"+a);b.store("position",a);var c=b.getElement("itemCheck");c.observe("change",this._selectRow.bind(this,c));c=b.getElement("descripcion");
c.observe("blur",this._onBlurDescripcion.bind(this,c));var d=b.getElement("tipo");d.observe("change",this._onChangeTipo.bind(this,d,a));d=b.getElement("item");d.observe("blur",this._onBlurItem.bind(this,d,a));new HfosAutocompleter(c,"referencias/queryByName",{paramName:"nombre",afterUpdateElement:this._updateCodigoItem.bind(this,d)});a=b.getElement("itemIvaVenta");c=b.getElement("itemPrecioVenta");b=b.getElement("cantidad");b.observe("blur",this._onBlurCantidad.bind(this,b,a,c))},_addGridFormCallbacks:function(a){var b=
this.getElement("lineaForma"+a);b.store("position",a);a=b.getElement("itemCheck");a.observe("change",this._selectRowForma.bind(this,a));b=b.getElement("valorForma");b.observe("blur",this._onBlurValorForma.bind(this,b))},_queryItemPrice:function(a,b){if(""!=b){controllerRequest="referencias/queryByItem";var c=this.selectOne("#nitFacturar").getValue(),d=this.selectOne("#numeroContrato").getValue();new HfosAjax.JsonRequest(controllerRequest,{method:"GET",parameters:"codigo="+b+"&contrato="+d+"&nit="+
c,onSuccess:function(a,b){if("OK"==b.status){a.lang=b.precio;var c=a.getElement("item");a.getElement("descripcion").setValue(b.nombre);var d=a.getElement("cantidad");(""==d.getValue()||"0"==d.getValue())&&d.setValue(1);var i=this.selectOne("#descuentoGeneral");a.getElement("itemIvaVenta").setValue(b.ivaVenta);parseFloat(b.precio,10);var j=parseFloat(b.precio,10);i&&0<i.getValue()&&(j-=j*parseFloat(i.getValue(),10)/100);a.getElement("precio").setValue(j);i=j*parseFloat(d.getValue(),10);parseFloat(d.getValue(),
10);a.getElement("total").setValue(Math.round(i));this.getMessages().setDefault();this._pushRowForUpdate(c);this._totalizeFactura()}else"FAILED"==b.status&&this.getMessages().error(b.message)}.bind(this,a)})}},_onBlurItem:function(a){a=a.up(1);this._queryItemPrice(a,a.getElement("item").getValue(),a.getElement("tipo").getValue())},_onChangeTipo:function(a){var b=a.up(1);"N"==a.getValue()?b.getElement("precio").readOnly=!1:b.getElement("precio").readOnly=!0;this._queryItemPrice(b,b.getElement("item").getValue(),
b.getElement("tipo").getValue())},_onBlurDescripcion:function(a){""!=a.getValue()&&this._pushRowForUpdate(a)},_onBlurCantidad:function(a){var b=a.up(1);if(""==b.lang)b.getElement("precio")||(b.getElement("total").setValue("0.00"),b.getElement("precio").setValue("0.00"),b.getElement("itemIvaVenta").setValue("0.00"),b.getElement("itemPrecioVenta").setValue("0.00"));else{var c=this.selectOne("input#descuentoGeneral"),d=parseFloat(b.lang,10),e=0;c&&c.getValue()&&(e=parseFloat(c.getValue(),10),0<e&&(d-=
d*e/100));c=d*parseFloat(a.getValue(),10);b.getElement("total").setValue(c);b.getElement("precio").setValue(d)}this._pushRowForUpdate(a);this._totalizeFactura()},_onBlurDescuento:function(a){var b=a.up(1),c=b.getElement("cantidad");c||alert("not found cantidadElement");var d=b.getElement("itemIvaVenta"),b=b.getElement("itemPrecioVenta");this._onBlurCantidad(c,d,b);this._pushRowForUpdate(a);this._totalizeFactura()},_onBlurValorForma:function(){this._totalizeFactura()},_totalizeFactura:function(){var a=
0,b=0,c=this.select("input.total");this.select("input.descuento");for(var d=0;d<c.length;d++)if(""!=c[d].getValue())var e=parseFloat(c[d].getValue(),10),a=a+Math.round(e);c=this.select("input.valorForma");for(d=0;d<c.length;d++)""!=c[d].getValue()&&(b+=parseFloat(c[d].getValue(),10));a=Utils.numberFormat(a);b=Utils.numberFormat(b);this._totalFactura.update('<table class="sumasTable"><tr><td>Total Factura <b>'+a+"</b></td><td>Total Formas Pago <b>"+b+"</b></td></tr></table>")},checkLoadPedido:function(a){var b=
this.select(".detalle-linea");1<b.length?new HfosModal.confirm({title:"Facturas",message:"Se han agregado referencias al detalle de la factura, \u00bfDesea ignorarlos y cargar el pedido?",onAccept:function(a,b){for(var e=1;e<b.length;e++)b[e].remove();this.loadPedido(a)}.bind(this,a,b)}):this.loadPedido(a)},_addLoadRow:function(a,b){b++;if(a.length>b){for(var c=[],d=["item","descripcion","cantidad","precio","itemIvaVenta"],e=parseFloat(this.selectOne("input#descuentoGeneral").getValue(),10),f=0;f<
d.length;f++){var g=d[f],h="itemIvaVenta"==g?a[b].ivaVenta:a[b][d[f]];c[d[f]]=this.select("."+g)[b];c[d[f]]?("precio"==g&&h&&(g=parseFloat(h,10),0<e&&(g-=g*e/100),h=g),c[d[f]].setValue(h)):alert("No se encontro campo con selector ."+g)}this.select(".total")[b].setValue(c.cantidad.getValue()*c.precio.getValue());this._pushRowForUpdate(c.item,this._addLoadRow.bind(this,a,b))}else this._totalizeFactura(),this._notifyContentChange()},loadPedido:function(a){var b=this.selectOne("#nitFacturar").getValue(),
c=this.selectOne("#numeroContrato").getValue(),a=parseInt(a.getValue(),10);0<a&&new HfosAjax.JsonRequest("tatico/getPedido",{method:"GET",checkAcl:!0,parameters:{numeroPedido:a,nit:b,contrato:c},onSuccess:function(a){"OK"==a.status?this._addLoadRow(a.data.movilin,-1):this.getMessages().error(a.message)}.bind(this)})},queryPedido:function(a){a=HfosCommon.findWindow(a);new HfosModalForm(a,"pedidos/consultar",{notSubmit:!0,style:{width:"650px"},afterShow:function(a,c){this.addQueryPedidoCallbacks(c,
a);c.getElement("consultarButton").observe("click",function(c){var e=c.getElement("pedidoForm");new HfosAjax.FormRequest(e,{onLoading:function(a){a.getElement("formSpinner").show()}.bind(this,c),onSuccess:function(a,b,c){a.getElement("pedidos").update(c.responseText);this.addQueryPedidoCallbacks(a,b)}.bind(this,c,a),onComplete:function(a){a.getElement("formSpinner").hide()}.bind(this,c)})}.bind(this,c))}.bind(this,a)})},addQueryPedidoCallbacks:function(a,b){var c=a.selectOne("table#pedidosTable");
if(null!=c){(new HfosBrowseData(a)).fromHtmlTable(a,c,5);for(var c=c.select("input.seleccionarButton"),d=0;d<c.length;d++)c[d].lang=c[d].title,c[d].title="Seleccionar el pedido",c[d].observe("click",function(a,b,c){b.close();a=a.lang.split("-");c=c.selectOne("input#numeroPedido");c.setValue(a[1]);c.activate()}.bind(this,c[d],a,b))}else a.getMessages().notice("No se encontraron pedidos")}});HfosBindings.late("win-facturas","afterCreate",function(a){new Facturas(a)});
